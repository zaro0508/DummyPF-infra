# This CF script is for creating an AWS elastic beanstalk application.
#
# Usage:
#   1. Run the boostrap script to setup required resources for the app.
#   2. Create the app with `aws cloudformation --create-stack` command
#   3. Update the stack with `aws cloudformation --update-stack` command
#
# initial creation:
#   aws --profile aws.admin.user --region us-east-1 cloudformation \
#     create-stack --stack-name foo-develop --capabilities CAPABILITY_NAMED_IAM \
#     --on-failure DELETE --template-body file://cf_templates/cf_bridgepf.yml \
#     --parameters ParameterKey=AppDeployBucket,ParameterValue=org-sagebridge-bridgepf-deployment-foo-develop \
#     --parameters ParameterKey=EC2InstanceType,ParameterValue=t2.micro \
#     ...[all params neeeded for app]
#
# updates:
#   aws --profile aws.bootstrap.user --region us-east-1 cloudformation \
#     update-stack --stack-name foo-develop --capabilities CAPABILITY_NAMED_IAM \
#     --template-body file://cf_templates/cf_bridgepf.yml \
#     --parameters ParameterKey=AppDeployBucket,ParameterValue=org-sagebridge-bridgepf-deployment-foo-develop \
#     --parameters ParameterKey=EC2InstanceType,ParameterValue=t2.micro \
#     ...[all params neeeded for app]
#
Description: AWS Elastic Beanstalk Application
AWSTemplateFormatVersion: 2010-09-09
Outputs:
  AWSEC2VPC:
    Value: !Ref AWSEC2VPC
    Export:
      Name: !Sub '${AWS::StackName}-Vpc'
  AWSS3AppDeployBucket:
    Value: !Ref AWSS3AppDeployBucket
    Export:
      Name: !Sub '${AWS::StackName}-AppDeployBucket'
  AWSEBApplication:
    Value: !Ref AWSEBApplication
    Export:
      Name: !Sub '${AWS::StackName}-Application'
  AWSEBEnvironment:
    Value: !Ref AWSEBEnvironment
    Export:
      Name: !Sub '${AWS::StackName}-Environment'
  AWSEBEnvironmentUrl:
    Value: !Join
      - ''
      - - 'http://'
        - !GetAtt
          - AWSEBEnvironment
          - EndpointURL
    Export:
      Name: !Sub '${AWS::StackName}-EnvironmentUrl'
  AWSECacheUrl:
    Value: !Join
      - ''
      - - 'redis://'
        - !GetAtt
          - AWSECCacheCluster
          - RedisEndpoint.Address
        - ':'
        - !GetAtt
          - AWSECCacheCluster
          - RedisEndpoint.Port
    Export:
      Name: !Sub '${AWS::StackName}-ElastiCacheUrl'
  AWSIAMUserAccessKeyId:
    Value: !Ref AWSIAMUserAccessKey
    Export:
      Name: !Sub '${AWS::StackName}-UserAccessKeyId'
  AWSIAMUserSecretAccessKeyId:
    Value: !GetAtt AWSIAMUserAccessKey.SecretAccessKey
    Export:
      Name: !Sub '${AWS::StackName}-SecretAccessKeyId'
  AWSS3AttachmentBucket:
    Value: !Ref AWSS3AttachmentBucket
    Export:
      Name: !Sub '${AWS::StackName}-AttachmentBucket'
  AWSS3ConsentsBucket:
    Value: !Ref AWSS3ConsentsBucket
    Export:
      Name: !Sub '${AWS::StackName}-ConsentsBucket'
  AWSS3UploadBucket:
    Value: !Ref AWSS3UploadBucket
    Export:
      Name: !Sub '${AWS::StackName}-UploadBucket'
  AWSS3UploadCmsCertBucket:
    Value: !Ref AWSS3UploadCmsCertBucket
    Export:
      Name: !Sub '${AWS::StackName}-UploadCmsCertBucket'
  AWSS3UploadCmsPrivBucket:
    Value: !Ref AWSS3UploadCmsPrivBucket
    Export:
      Name: !Sub '${AWS::StackName}-UploadCmsPrivBucket'
  AvailabilityZones:
    Value: !Join
      - ','
      - - !GetAtt
          - AWSEC2SubnetUsEast1a
          - AvailabilityZone
        - !GetAtt
          - AWSEC2SubnetUsEast1b
          - AvailabilityZone
        - !GetAtt
          - AWSEC2SubnetUsEast1c
          - AvailabilityZone
        - !GetAtt
          - AWSEC2SubnetUsEast1d
          - AvailabilityZone
        - !GetAtt
          - AWSEC2SubnetUsEast1e
          - AvailabilityZone
        - !GetAtt
          - AWSEC2SubnetUsEast1f
          - AvailabilityZone
    Export:
      Name: !Sub '${AWS::StackName}-AvailabilityZones'
  PublicSubnets:
    Value: !Join
      - ','
      - - !Ref AWSEC2SubnetUsEast1a
        - !Ref AWSEC2SubnetUsEast1b
        - !Ref AWSEC2SubnetUsEast1c
        - !Ref AWSEC2SubnetUsEast1d
        - !Ref AWSEC2SubnetUsEast1e
        - !Ref AWSEC2SubnetUsEast1f
    Export:
      Name: !Sub '${AWS::StackName}-PublicSubnets'
Parameters:
  AppDeployBucket:
    Type: String
    Default: param_place_holder
  AppHealthcheckUrl:
    Type: String
    Description: The AWS EB health check path
    Default: param_place_holder
  AuthCreateMysqlAccounts:
    Type: String
    Default: param_place_holder
  AuthProvider:
    Type: String
    Default: param_place_holder
  AwsAutoScalingMaxSize:
    Type: String
    Default: param_place_holder
  AwsAutoScalingMinSize:
    Type: String
    Default: param_place_holder
  AwsDefaultVpcId:
    Description: The AWS account's default VPC id
    Type: String
    Default: param_place_holder
  AwsEbNotificationEndpoint:
    Type: String
    Description: Email address for AWS EB notifications
    Default: param_place_holder
    NoEcho: true
  AwsKey:
    Type: String
    Default: param_place_holder
  AwsKeyUpload:
    Type: String
    Default: param_place_holder
  AwsKeyUploadCms:
    Type: String
    Default: param_place_holder
  AwsSecretKey:
    Type: String
    Default: param_place_holder
    NoEcho: true
  AwsSecretKeyConsents:
    Type: String
    Default: param_place_holder
    NoEcho: true
  AwsSecretKeyUpload:
    Type: String
    Default: param_place_holder
    NoEcho: true
  AwsSecretKeyUploadCms:
    Type: String
    Default: param_place_holder
    NoEcho: true
  AwsVpcSubnetPrefix:
    Description: The VPC subnet prefix (i.e. 172.32)
    Type: String
    Default: param_place_holder
  BridgeEnv:
    Type: String
    Default: param_place_holder
  BridgeHealthcodeKey:
    Type: String
    Default: param_place_holder
    NoEcho: true
  BridgeUser:
    Type: String
    Default: param_place_holder
  DNSDomain:
    Type: String
    Description: DNS Domain name for deployment
    Default: param_place_holder
  DNSHostname:
    Type: String
    Description: DNS Hostname for deployment
    Default: param_place_holder
  EC2InstanceType:
    Type: String
    Description: Instance type to use for Elastic Beanstalk Instances
    Default: t2.micro
    AllowedValues:
      - t1.micro
      - t2.nano
      - t2.micro
      - t2.small
      - t2.medium
      - t2.large
      - t2.xlarge
      - t2.2xlarge
      - m1.small
      - m1.medium
      - m1.large
      - m1.xlarge
      - m3.medium
      - m3.large
      - m3.xlarge
      - m3.2xlarge
      - m4.large
      - m4.xlarge
      - m4.2xlarge
      - m4.4xlarge
      - m4.10xlarge
      - m4.16xlarge
      - m2.xlarge
      - m2.2xlarge
      - m2.4xlarge
      - cr1.8xlarge
      - r3.large
      - r3.xlarge
      - r3.2xlarge
      - r3.4xlarge
      - r3.8xlarge
      - r4.large
      - r4.xlarge
      - r4.2xlarge
      - r4.4xlarge
      - r4.8xlarge
      - r4.16xlarge
      - x1.16xlarge
      - x1.32xlarge
      - i2.xlarge
      - i2.2xlarge
      - i2.4xlarge
      - i2.8xlarge
      - hi1.4xlarge
      - hs1.8xlarge
      - c1.medium
      - c1.xlarge
      - c3.large
      - c3.xlarge
      - c3.2xlarge
      - c3.4xlarge
      - c3.8xlarge
      - c4.large
      - c4.xlarge
      - c4.2xlarge
      - c4.4xlarge
      - c4.8xlarge
      - cc1.4xlarge
      - cc2.8xlarge
      - g2.2xlarge
      - g2.8xlarge
      - cg1.4xlarge
      - p2.xlarge
      - p2.8xlarge
      - p2.16xlarge
      - d2.xlarge
      - d2.2xlarge
      - d2.4xlarge
      - d2.8xlarge
      - f1.2xlarge
      - f1.16xlarge
  EmailUnsubscribeToken:
    Type: String
    Default: param_place_holder
  ElastiCacheInstanceType:
    Type: String
    Description: Instance type to use for Elastic Cache cluster
    Default: cache.t2.micro
    AllowedValues:
      - cache.t2.micro
      - cache.t2.small
      - cache.t2.medium
      - cache.m3.medium
      - cache.m3.large
      - cache.m3.xlarge
      - cache.m3.2xlarge
      - cache.r3.large
      - cache.r3.xlarge
      - cache.r3.2xlarge
      - cache.r3.4xlarge
      - cache.r3.8xlarge
  ElastiCacheUrl:
    Type: String
    Default: param_place_holder
  HibernateConnectionPassword:
    Type: String
    Default: param_place_holder
    NoEcho: true
  HibernateConnectionUrl:
    Type: String
    Default: param_place_holder
  HibernateConnectionUsername:
    Type: String
    Default: param_place_holder
  HibernateConnectionUsessl:
    Type: String
    Default: param_place_holder
  HostPostfix:
    Type: String
    Default: param_place_holder
  JavaOpts:
    Type: String
    Default: param_place_holder
  NewRelicAppName:
    Type: String
    Default: param_place_holder
  NewRelicLicenseKey:
    Type: String
    Default: param_place_holder
    NoEcho: true
  NewRelicLog:
    Type: String
    Default: param_place_holder
  RedisCloudUrl:
    Type: String
    Default: param_place_holder
  SnsKey:
    Type: String
    Default: param_place_holder
  SnsSecretKey:
    Type: String
    NoEcho: true
    Default: param_place_holder
  SSLCertArn:
    Description: SSL certificate for load balancer
    Type: String
    Default: param_place_holder
  SynapseApiKey:
    Type: String
    Default: param_place_holder
  SynapseUser:
    Type: String
    Default: param_place_holder
  SysopsEmail:
    Type: String
    Default: param_place_holder
  WebservicesUrl:
    Type: String
    Default: param_place_holder
Resources:
  AWSEC2InternetGateway:
    Type: "AWS::EC2::InternetGateway"
  AWSEC2VPCGatewayAttachment:
    Type: "AWS::EC2::VPCGatewayAttachment"
    Properties:
      InternetGatewayId: !Ref AWSEC2InternetGateway
      VpcId: !Ref AWSEC2VPC
  AWSEC2DHCPOptions:
    Type: "AWS::EC2::DHCPOptions"
    Properties:
       DomainName: ec2.internal
       DomainNameServers:
        - AmazonProvidedDNS
  AWSEC2VPCDHCPOptionsAssociation:
    Type: "AWS::EC2::VPCDHCPOptionsAssociation"
    Properties:
      DhcpOptionsId: !Ref AWSEC2DHCPOptions
      VpcId: !Ref AWSEC2VPC
  AWSEC2VPC:
    Type: "AWS::EC2::VPC"
    Properties:
      CidrBlock: !Join
        - '.'
        - - !Ref AwsVpcSubnetPrefix
          - 0.0/16
      EnableDnsSupport: 'true'
      EnableDnsHostnames: 'true'
      InstanceTenancy: default
  AWSEC2RouteTable:
    Type: "AWS::EC2::RouteTable"
    Properties:
      VpcId: !Ref AWSEC2VPC
  AWSEC2SubnetRouteTableAssociationEast1a:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref AWSEC2SubnetUsEast1a
      RouteTableId: !Ref AWSEC2RouteTable
  AWSEC2SubnetRouteTableAssociationEast1b:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref AWSEC2SubnetUsEast1b
      RouteTableId: !Ref AWSEC2RouteTable
  AWSEC2SubnetRouteTableAssociationEast1c:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref AWSEC2SubnetUsEast1c
      RouteTableId: !Ref AWSEC2RouteTable
  AWSEC2SubnetRouteTableAssociationEast1d:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref AWSEC2SubnetUsEast1d
      RouteTableId: !Ref AWSEC2RouteTable
  AWSEC2SubnetRouteTableAssociationEast1e:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref AWSEC2SubnetUsEast1e
      RouteTableId: !Ref AWSEC2RouteTable
  AWSEC2SubnetRouteTableAssociationEast1f:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref AWSEC2SubnetUsEast1f
      RouteTableId: !Ref AWSEC2RouteTable
  AWSEC2Route:
    Type: AWS::EC2::Route
    DependsOn: AWSEC2VPCGatewayAttachment
    Properties:
      RouteTableId: !Ref AWSEC2RouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref AWSEC2InternetGateway
  AWSEC2NetworkAcl:
    Type: "AWS::EC2::NetworkAcl"
    Properties:
      VpcId: !Ref AWSEC2VPC
  AWSEC2NetworkAclEntryIngress:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref AWSEC2NetworkAcl
      RuleNumber: '100'
      Protocol: "-1"
      RuleAction: allow
      CidrBlock: 0.0.0.0/0
  AWSEC2NetworkAclEntryEgress:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref AWSEC2NetworkAcl
      RuleNumber: '100'
      Egress: true
      Protocol: "-1"
      RuleAction: allow
      CidrBlock: 0.0.0.0/0
  AWSEC2SubnetUsEast1a:
    Type: "AWS::EC2::Subnet"
    Properties:
      MapPublicIpOnLaunch: true
      VpcId: !Ref AWSEC2VPC
      CidrBlock: !Join
        - '.'
        - - !Ref AwsVpcSubnetPrefix
          - 0.0/20
      AvailabilityZone: !Select
        - 0
        - Fn::GetAZs: ""
  AWSEC2SubnetUsEast1b:
    Type: "AWS::EC2::Subnet"
    Properties:
      MapPublicIpOnLaunch: true
      VpcId: !Ref AWSEC2VPC
      CidrBlock: !Join
        - '.'
        - - !Ref AwsVpcSubnetPrefix
          - 16.0/20
      AvailabilityZone: !Select
        - 1
        - Fn::GetAZs: ""
  AWSEC2SubnetUsEast1c:
    Type: "AWS::EC2::Subnet"
    Properties:
      MapPublicIpOnLaunch: true
      VpcId: !Ref AWSEC2VPC
      CidrBlock: !Join
        - '.'
        - - !Ref AwsVpcSubnetPrefix
          - 32.0/20
      AvailabilityZone: !Select
        - 2
        - Fn::GetAZs: ""
  AWSEC2SubnetUsEast1d:
    Type: "AWS::EC2::Subnet"
    Properties:
      MapPublicIpOnLaunch: true
      VpcId: !Ref AWSEC2VPC
      CidrBlock: !Join
        - '.'
        - - !Ref AwsVpcSubnetPrefix
          - 48.0/20
      AvailabilityZone: !Select
        - 3
        - Fn::GetAZs: ""
  AWSEC2SubnetUsEast1e:
    Type: "AWS::EC2::Subnet"
    Properties:
      MapPublicIpOnLaunch: true
      VpcId: !Ref AWSEC2VPC
      CidrBlock: !Join
        - '.'
        - - !Ref AwsVpcSubnetPrefix
          - 64.0/20
      AvailabilityZone: !Select
        - 4
        - Fn::GetAZs: ""
  AWSEC2SubnetUsEast1f:
    Type: "AWS::EC2::Subnet"
    Properties:
      MapPublicIpOnLaunch: true
      VpcId: !Ref AWSEC2VPC
      CidrBlock: !Join
        - '.'
        - - !Ref AwsVpcSubnetPrefix
          - 80.0/20
      AvailabilityZone: !Select
        - 5
        - Fn::GetAZs: ""
  AWSEC2SubnetNetworkAclAssociationUsEast1a:
    Type: "AWS::EC2::SubnetNetworkAclAssociation"
    Properties:
      SubnetId: !Ref AWSEC2SubnetUsEast1a
      NetworkAclId: !Ref AWSEC2NetworkAcl
  AWSEC2SubnetNetworkAclAssociationUsEast1b:
    Type: "AWS::EC2::SubnetNetworkAclAssociation"
    Properties:
      SubnetId: !Ref AWSEC2SubnetUsEast1b
      NetworkAclId: !Ref AWSEC2NetworkAcl
  AWSEC2SubnetNetworkAclAssociationUsEast1c:
    Type: "AWS::EC2::SubnetNetworkAclAssociation"
    Properties:
      SubnetId: !Ref AWSEC2SubnetUsEast1c
      NetworkAclId: !Ref AWSEC2NetworkAcl
  AWSEC2SubnetNetworkAclAssociationUsEast1d:
    Type: "AWS::EC2::SubnetNetworkAclAssociation"
    Properties:
      SubnetId: !Ref AWSEC2SubnetUsEast1d
      NetworkAclId: !Ref AWSEC2NetworkAcl
  AWSEC2SubnetNetworkAclAssociationUsEast1e:
    Type: "AWS::EC2::SubnetNetworkAclAssociation"
    Properties:
      SubnetId: !Ref AWSEC2SubnetUsEast1e
      NetworkAclId: !Ref AWSEC2NetworkAcl
  AWSEC2SubnetNetworkAclAssociationUsEast1f:
    Type: "AWS::EC2::SubnetNetworkAclAssociation"
    Properties:
      SubnetId: !Ref AWSEC2SubnetUsEast1f
      NetworkAclId: !Ref AWSEC2NetworkAcl
  AWSEC2VPCPeeringConnection:
    Type: "AWS::EC2::VPCPeeringConnection"
    Properties:
      PeerVpcId: !Ref AwsDefaultVpcId
      VpcId: !Ref AWSEC2VPC
  AWSEBConfigurationTemplate:
    Type: 'AWS::ElasticBeanstalk::ConfigurationTemplate'
    Properties:
      ApplicationName: !Ref AWSEBApplication
      SolutionStackName: 64bit Amazon Linux 2017.03 v2.5.2 running Java 8
      OptionSettings:
        # EB environment options
        - Namespace: 'aws:autoscaling:asg'
          OptionName: MaxSize
          Value: !Ref AwsAutoScalingMaxSize
        - Namespace: 'aws:autoscaling:asg'
          OptionName: MinSize
          Value: !Ref AwsAutoScalingMinSize
        - Namespace: 'aws:autoscaling:launchconfiguration'
          OptionName: IamInstanceProfile
          Value: !Ref AWSIAMInstanceProfile
        - Namespace: 'aws:autoscaling:launchconfiguration'
          OptionName: InstanceType
          Value: !Ref EC2InstanceType
        - Namespace: 'aws:autoscaling:launchconfiguration'
          OptionName: SecurityGroups
          Value: !Join
            - '-'
            - - !Ref 'AWS::StackName'
              - AWSEC2SecurityGroup
        - Namespace: 'aws:autoscaling:updatepolicy:rollingupdate'
          OptionName: RollingUpdateEnabled
          Value: true
        - Namespace: 'aws:autoscaling:updatepolicy:rollingupdate'
          OptionName: RollingUpdateType
          Value: 'Health'
        - Namespace: 'aws:elasticbeanstalk:application'
          OptionName: Application Healthcheck URL
          Value: !Ref AppHealthcheckUrl
        - Namespace: 'aws:elasticbeanstalk:cloudwatch:logs'
          OptionName: StreamLogs
          Value: 'true'
        - Namespace: 'aws:elasticbeanstalk:cloudwatch:logs'
          OptionName: DeleteOnTerminate
          Value: 'true'
        - Namespace: 'aws:elasticbeanstalk:cloudwatch:logs'
          OptionName: RetentionInDays
          Value: '7'
        - Namespace: 'aws:elasticbeanstalk:command'
          OptionName: DeploymentPolicy
          Value: 'RollingWithAdditionalBatch'
        - Namespace: 'aws:elasticbeanstalk:environment'
          OptionName: ServiceRole
          Value: !Ref AWSIAMServiceRole
        - Namespace: 'aws:elasticbeanstalk:environment:process:default'
          OptionName: Protocol
          Value: 'HTTP'
        - Namespace: 'aws:elasticbeanstalk:environment:process:default'
          OptionName: HealthCheckPath
          Value: !Ref AppHealthcheckUrl
        - Namespace: 'aws:elasticbeanstalk:sns:topics'
          OptionName: Notification Endpoint
          Value: !Ref AwsEbNotificationEndpoint
        - Namespace: 'aws:elasticbeanstalk:hostmanager'
          OptionName: LogPublicationControl
          Value: true
        - Namespace: 'aws:elasticbeanstalk:xray'
          OptionName: XRayEnabled
          Value: false
        # Application environment options
        - Namespace: 'aws:elasticbeanstalk:application:environment'
          OptionName: APP_DEPLOY_BUCKET
          Value: !Ref AppDeployBucket
        - Namespace: 'aws:elasticbeanstalk:application:environment'
          OptionName: AUTH_CREATE_MYSQL_ACCOUNTS
          Value: !Ref AuthCreateMysqlAccounts
        - Namespace: 'aws:elasticbeanstalk:application:environment'
          OptionName: AUTH_PROVIDER
          Value: !Ref AuthProvider
        - Namespace: 'aws:elasticbeanstalk:application:environment'
          OptionName: AWS_KEY
          Value: !Ref AwsKey
        - Namespace: 'aws:elasticbeanstalk:application:environment'
          OptionName: AWS_KEY_UPLOAD
          Value: !Ref AwsKeyUpload
        - Namespace: 'aws:elasticbeanstalk:application:environment'
          OptionName: AWS_KEY_UPLOAD_CMS
          Value: !Ref AwsKeyUploadCms
        - Namespace: 'aws:elasticbeanstalk:application:environment'
          OptionName: AWS_SECRET_KEY
          Value: !Ref AwsSecretKey
        - Namespace: 'aws:elasticbeanstalk:application:environment'
          OptionName: AWS_SECRET_KEY_CONSENTS
          Value: !Ref AwsSecretKeyConsents
        - Namespace: 'aws:elasticbeanstalk:application:environment'
          OptionName: AWS_SECRET_KEY_UPLOAD
          Value: !Ref AwsSecretKeyUpload
        - Namespace: 'aws:elasticbeanstalk:application:environment'
          OptionName: AWS_SECRET_KEY_UPLOAD_CMS
          Value: !Ref AwsSecretKeyUploadCms
        - Namespace: 'aws:elasticbeanstalk:application:environment'
          OptionName: BRIDGE_ENV
          Value: !Ref BridgeEnv
        - Namespace: 'aws:elasticbeanstalk:application:environment'
          OptionName: BRIDGE_HEALTHCODE_KEY
          Value: !Ref BridgeHealthcodeKey
        - Namespace: 'aws:elasticbeanstalk:application:environment'
          OptionName: BRIDGE_USER
          Value: !Ref BridgeUser
        - Namespace: 'aws:elasticbeanstalk:application:environment'
          OptionName: EMAIL_UNSUBSCRIBE_TOKEN
          Value: !Ref EmailUnsubscribeToken
        - Namespace: 'aws:elasticbeanstalk:application:environment'
          OptionName: ELASTICACHE_URL
          Value: !Ref ElastiCacheUrl
        - Namespace: 'aws:elasticbeanstalk:application:environment'
          OptionName: HIBERNATE_CONNECTION_PASSWORD
          Value: !Ref HibernateConnectionPassword
        - Namespace: 'aws:elasticbeanstalk:application:environment'
          OptionName: HIBERNATE_CONNECTION_URL
          Value: !Ref HibernateConnectionUrl
        - Namespace: 'aws:elasticbeanstalk:application:environment'
          OptionName: HIBERNATE_CONNECTION_USERNAME
          Value: !Ref HibernateConnectionUsername
        - Namespace: 'aws:elasticbeanstalk:application:environment'
          OptionName: HIBERNATE_CONNECTION_USESSL
          Value: !Ref HibernateConnectionUsessl
        - Namespace: 'aws:elasticbeanstalk:application:environment'
          OptionName: HOST_POSTFIX
          Value: !Ref HostPostfix
        - Namespace: 'aws:elasticbeanstalk:application:environment'
          OptionName: JAVA_OPTS
          Value: !Ref JavaOpts
        - Namespace: 'aws:elasticbeanstalk:application:environment'
          OptionName: NEW_RELIC_APP_NAME
          Value: !Ref NewRelicAppName
        - Namespace: 'aws:elasticbeanstalk:application:environment'
          OptionName: NEW_RELIC_LICENSE_KEY
          Value: !Ref NewRelicLicenseKey
        - Namespace: 'aws:elasticbeanstalk:application:environment'
          OptionName: NEW_RELIC_LOG
          Value: !Ref NewRelicLog
        - Namespace: 'aws:elasticbeanstalk:application:environment'
          OptionName: REDISCLOUD_URL
          Value: !Ref RedisCloudUrl
        - Namespace: 'aws:elasticbeanstalk:application:environment'
          OptionName: SNS_KEY
          Value: !Ref SnsKey
        - Namespace: 'aws:elasticbeanstalk:application:environment'
          OptionName: SNS_SECRET_KEY
          Value: !Ref SnsSecretKey
        - Namespace: 'aws:elasticbeanstalk:application:environment'
          OptionName: SYNAPSE_API_KEY
          Value: !Ref SynapseApiKey
        - Namespace: 'aws:elasticbeanstalk:application:environment'
          OptionName: SYNAPSE_USER
          Value: !Ref SynapseUser
        - Namespace: 'aws:elasticbeanstalk:application:environment'
          OptionName: SYSOPS_EMAIL
          Value: !Ref SysopsEmail
        - Namespace: 'aws:elasticbeanstalk:application:environment'
          OptionName: WEBSERVICES_URL
          Value: !Ref WebservicesUrl
  AWSEBApplication:
    Type: 'AWS::ElasticBeanstalk::Application'
    Properties:
      ApplicationName: !Join
        - '-'
        - - !Ref 'AWS::StackName'
          - application
  AWSEBEnvironment:
    Type: 'AWS::ElasticBeanstalk::Environment'
    Properties:
      ApplicationName: !Ref AWSEBApplication
      TemplateName: !Ref AWSEBConfigurationTemplate
      EnvironmentName: !Join
        - '-'
        - - !Ref 'AWS::StackName'
      Tier:
        Name: WebServer
        Type: Standard

  AWSS3AppDeployBucket:
    Type: 'AWS::S3::Bucket'
    Properties:
      BucketName: !Ref AppDeployBucket
  AWSS3UploadBucket:
    Type: 'AWS::S3::Bucket'
  AWSS3AttachmentBucket:
    Type: 'AWS::S3::Bucket'
  AWSS3UploadCmsCertBucket:
    Type: 'AWS::S3::Bucket'
  AWSS3UploadCmsPrivBucket:
    Type: 'AWS::S3::Bucket'
  AWSS3ConsentsBucket:
    Type: 'AWS::S3::Bucket'
  AWSS3BucketPolicy:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyName: !Join
        - '-'
        - - !Ref AWSEBApplication
          - bucket-policy
      Groups:
        - !Ref AWSIAMGroup
      PolicyDocument:
        Id: Give access to user
        Statement:
          - Sid: ListAccess
            Action:
              - 's3:ListBucket'
              - 's3:GetBucketLocation'
            Effect: Allow
            Resource:
              - !Join
                - ''
                - - 'arn:aws:s3:::'
                  - !Ref AWSS3AppDeployBucket
              - !Join
                - ''
                - - 'arn:aws:s3:::'
                  - !Ref AWSS3UploadBucket
              - !Join
                - ''
                - - 'arn:aws:s3:::'
                  - !Ref AWSS3AttachmentBucket
              - !Join
                - ''
                - - 'arn:aws:s3:::'
                  - !Ref AWSS3UploadCmsCertBucket
              - !Join
                - ''
                - - 'arn:aws:s3:::'
                  - !Ref AWSS3UploadCmsPrivBucket
              - !Join
                - ''
                - - 'arn:aws:s3:::'
                  - !Ref AWSS3ConsentsBucket
          - Sid: ModAccess
            Action:
              - 's3:PutObject'
              - 's3:PutObjectAcl'
              - 's3:GetObject'
              - 's3:GetObjectAcl'
              - 's3:DeleteObject'
            Effect: Allow
            Resource:
              - !Join
                - ''
                - - 'arn:aws:s3:::'
                  - !Ref AWSS3AppDeployBucket
                  - /*
              - !Join
                - ''
                - - 'arn:aws:s3:::'
                  - !Ref AWSS3UploadBucket
                  - /*
              - !Join
                - ''
                - - 'arn:aws:s3:::'
                  - !Ref AWSS3AttachmentBucket
                  - /*
              - !Join
                - ''
                - - 'arn:aws:s3:::'
                  - !Ref AWSS3UploadCmsCertBucket
                  - /*
              - !Join
                - ''
                - - 'arn:aws:s3:::'
                  - !Ref AWSS3UploadCmsPrivBucket
                  - /*
              - !Join
                - ''
                - - 'arn:aws:s3:::'
                  - !Ref AWSS3ConsentsBucket
                  - /*
  AWSIAMUserAccessKey:
    Type: 'AWS::IAM::AccessKey'
    Properties:
      UserName: !Ref AWSIAMUser
  AWSIAMUser:
    Type: 'AWS::IAM::User'
    Properties:
      Groups:
        - !Ref AWSIAMGroup
  AWSIAMGroup:
    Type: 'AWS::IAM::Group'
    Properties:
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AWSDeviceFarmFullAccess
  AWSR53RecordSet:
    Type: 'AWS::Route53::RecordSet'
    DependsOn: AWSEBLoadBalancer
    Properties:
      HostedZoneName: !Join
        - ''
        - - !Ref DNSDomain
          - .
      Name: !Join
        - ''
        - - !Ref DNSHostname
          - .
          - !Ref DNSDomain
          - .
      Type: CNAME
      TTL: '900'
      ResourceRecords:
        - !GetAtt
          - AWSEBEnvironment
          - EndpointURL
  AWSIAMServiceRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - elasticbeanstalk.amazonaws.com
            Action:
              - 'sts:AssumeRole'
            Condition:
              StringEquals:
                sts:ExternalId: elasticbeanstalk
      Path: /
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AWSElasticBeanstalkEnhancedHealth'
        - 'arn:aws:iam::aws:policy/service-role/AWSElasticBeanstalkService'
  AWSIAMRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - 'sts:AssumeRole'
      Path: /
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/AWSElasticBeanstalkWebTier'
  AWSIAMInstanceProfile:
    Type: 'AWS::IAM::InstanceProfile'
    Properties:
      Path: /
      Roles:
        - !Ref AWSIAMRole
  AWSSNSTopic:
    Type: "AWS::SNS::Topic"
    Properties:
      Subscription:
        -
          Endpoint: !Ref AwsEbNotificationEndpoint
          Protocol: "email"
  AWSLogsLogGroup:
    Type: "AWS::Logs::LogGroup"
    Properties:
      LogGroupName: !Join
        - '/'
        - - /aws/elasticbeanstalk
          - !Ref 'AWS::StackName'
          - var/log/web-1.log
      RetentionInDays: 7
  AWSLogsLogGroupWebError:
    Type: "AWS::Logs::LogGroup"
    Properties:
      LogGroupName: !Join
        - '/'
        - - /aws/elasticbeanstalk
          - !Ref 'AWS::StackName'
          - var/log/web-1.error.log
      RetentionInDays: 7
  AWSCWRequestErrorMetricFilter:
    Type: "AWS::Logs::MetricFilter"
    DependsOn: AWSLogsLogGroup
    Properties:
      LogGroupName: !Join
        - '/'
        - - /aws/elasticbeanstalk
          - !Ref 'AWS::StackName'
          - var/log/web-1.log
      FilterPattern: 'ERROR - com.newrelic.agent.ForceRestartException - INFO - org.hibernate - "Error R14"'
      MetricTransformations:
        -
          MetricValue: "1"
          MetricNamespace: "LogMetrics/Errors"
          MetricName: "ErrorCount"
  AWSCWRequestErrorAlarm:
    Type: "AWS::CloudWatch::Alarm"
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AWSSNSTopic
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: 1
      MetricName: ErrorCount
      Namespace: LogMetrics/Errors
      Period: 3600
      Statistic: Sum
      Threshold: 10
  AWSCWLostMessageMetricFilter:
    Type: "AWS::Logs::MetricFilter"
    DependsOn: AWSLogsLogGroup
    Properties:
      LogGroupName: !Join
        - '/'
        - - /aws/elasticbeanstalk
          - !Ref 'AWS::StackName'
          - var/log/web-1.log
      FilterPattern: '"Error L"'
      MetricTransformations:
        -
          MetricValue: "1"
          MetricNamespace: "LogMetrics/LostMessages"
          MetricName: "LostMessageCount"
  AWSCWRequestLostMessageAlarm:
    Type: "AWS::CloudWatch::Alarm"
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AWSSNSTopic
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: 1
      MetricName: LostMessageCount
      Namespace: LogMetrics/LostMessages
      Period: 3600
      Statistic: Sum
      Threshold: 1
  AWSCWRequestWarningMetricFilter:
    Type: "AWS::Logs::MetricFilter"
    DependsOn: AWSLogsLogGroup
    Properties:
      LogGroupName: !Join
        - '/'
        - - /aws/elasticbeanstalk
          - !Ref 'AWS::StackName'
          - var/log/web-1.log
      FilterPattern: 'WARN - "Establishing SSL"'
      MetricTransformations:
        -
          MetricValue: "1"
          MetricNamespace: "LogMetrics/Warnings"
          MetricName: "WarningCount"
  AWSCWRequestWarningAlarm:
    Type: "AWS::CloudWatch::Alarm"
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AWSSNSTopic
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: 1
      MetricName: WarningCount
      Namespace: LogMetrics/Warnings
      Period: 3600
      Statistic: Sum
      Threshold: 100
  AWSCWThroughputExceptionMetricFilter:
    Type: "AWS::Logs::MetricFilter"
    DependsOn: AWSLogsLogGroup
    Properties:
      LogGroupName: !Join
        - '/'
        - - /aws/elasticbeanstalk
          - !Ref 'AWS::StackName'
          - var/log/web-1.log
      FilterPattern: 'ProvisionedThroughputExceededException'
      MetricTransformations:
        -
          MetricValue: "1"
          MetricNamespace: "LogMetrics/Exceptions"
          MetricName: "ThroughputExceededExceptionCount"
  AWSCWThroughputExceptionAlarm:
    Type: "AWS::CloudWatch::Alarm"
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AWSSNSTopic
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: 1
      MetricName: ThroughputExceededExceptionCount
      Namespace: LogMetrics/Exceptions
      Period: 3600
      Statistic: Sum
      Threshold: 1
  AWSCW400MetricFilter:
    Type: "AWS::Logs::MetricFilter"
    DependsOn: AWSLogsLogGroup
    Properties:
      LogGroupName: !Join
        - '/'
        - - /aws/elasticbeanstalk
          - !Ref 'AWS::StackName'
          - var/log/web-1.log
      FilterPattern: '"{ $.status = 400 }" - "favicon.ico" - "robots.txt" - "apple-touch-icon"'
      MetricTransformations:
        -
          MetricValue: "1"
          MetricNamespace: "LogMetrics/400s"
          MetricName: "400Count"
  AWSCW400Alarm:
    Type: "AWS::CloudWatch::Alarm"
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AWSSNSTopic
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: 1
      MetricName: 400Count
      Namespace: LogMetrics/400s
      Period: 3600
      Statistic: Sum
      Threshold: 30
  AWSCW403MetricFilter:
    Type: "AWS::Logs::MetricFilter"
    DependsOn: AWSLogsLogGroup
    Properties:
      LogGroupName: !Join
        - '/'
        - - /aws/elasticbeanstalk
          - !Ref 'AWS::StackName'
          - var/log/web-1.log
      FilterPattern: '"{ $.status = 403 }" - "favicon.ico" - "robots.txt" - "apple-touch-icon"'
      MetricTransformations:
        -
          MetricValue: "1"
          MetricNamespace: "LogMetrics/403s"
          MetricName: "403Count"
  AWSCW403Alarm:
    Type: "AWS::CloudWatch::Alarm"
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AWSSNSTopic
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: 1
      MetricName: 403Count
      Namespace: LogMetrics/403s
      Period: 3600
      Statistic: Sum
      Threshold: 10
  AWSCW409MetricFilter:
    Type: "AWS::Logs::MetricFilter"
    DependsOn: AWSLogsLogGroup
    Properties:
      LogGroupName: !Join
        - '/'
        - - /aws/elasticbeanstalk
          - !Ref 'AWS::StackName'
          - var/log/web-1.log
      FilterPattern: '"{ $.status = 409 }" - "favicon.ico" - "robots.txt" - "apple-touch-icon"'
      MetricTransformations:
        -
          MetricValue: "1"
          MetricNamespace: "LogMetrics/409s"
          MetricName: "409Count"
  AWSCW409Alarm:
    Type: "AWS::CloudWatch::Alarm"
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AWSSNSTopic
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: 1
      MetricName: 409Count
      Namespace: LogMetrics/409s
      Period: 3600
      Statistic: Sum
      Threshold: 10
  AWSCW412MetricFilter:
    Type: "AWS::Logs::MetricFilter"
    DependsOn: AWSLogsLogGroup
    Properties:
      LogGroupName: !Join
        - '/'
        - - /aws/elasticbeanstalk
          - !Ref 'AWS::StackName'
          - var/log/web-1.log
      FilterPattern: '"{ $.status = 412 }" - "favicon.ico" - "robots.txt" - "apple-touch-icon"'
      MetricTransformations:
        -
          MetricValue: "1"
          MetricNamespace: "LogMetrics/412s"
          MetricName: "412Count"
  AWSCW412Alarm:
    Type: "AWS::CloudWatch::Alarm"
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref AWSSNSTopic
      ComparisonOperator: GreaterThanOrEqualToThreshold
      EvaluationPeriods: 1
      MetricName: 412Count
      Namespace: LogMetrics/412s
      Period: 3600
      Statistic: Sum
      Threshold: 30
  AWSLBSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Load Balancer Security Group
      VpcId: !Ref AWSEC2VPC
      SecurityGroupIngress:
        - CidrIp: 0.0.0.0/0
          FromPort: '443'
          ToPort: '443'
          IpProtocol: tcp
        - CidrIp: 0.0.0.0/0
          FromPort: '80'
          ToPort: '80'
          IpProtocol: tcp
      SecurityGroupEgress:
        - CidrIp: 0.0.0.0/0
          FromPort: '80'
          ToPort: '80'
          IpProtocol: tcp
  AWSEC2SecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    DependsOn: AWSLBSecurityGroup
    Properties:
      GroupName: !Join
        - '-'
        - - !Ref 'AWS::StackName'
          - AWSEC2SecurityGroup
      GroupDescription: EC2 Security Group
      VpcId: !Ref AWSEC2VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: '80'
          ToPort: '80'
          SourceSecurityGroupId: !Ref AWSLBSecurityGroup
  AWSECacheSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: ElastiCache Security Group
      VpcId: !Ref AWSEC2VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: '6379'
          ToPort: '6379'
          SourceSecurityGroupId: !Ref AWSEC2SecurityGroup
  AWSECSubnetGroup:
    Type: 'AWS::ElastiCache::SubnetGroup'
    Properties:
      Description: Elasticache Subnet Group
      SubnetIds:
        - !Ref AWSEC2SubnetUsEast1a
        - !Ref AWSEC2SubnetUsEast1b
        - !Ref AWSEC2SubnetUsEast1c
        - !Ref AWSEC2SubnetUsEast1d
        - !Ref AWSEC2SubnetUsEast1e
        - !Ref AWSEC2SubnetUsEast1f
  AWSECCacheCluster:
    Type: 'AWS::ElastiCache::CacheCluster'
    DependsOn: AWSECacheSecurityGroup
    Properties:
      Engine: redis
      CacheNodeType: !Ref ElastiCacheInstanceType
      NumCacheNodes: '1'
      VpcSecurityGroupIds:
        - !Ref AWSECacheSecurityGroup
      CacheSubnetGroupName: !Ref AWSECSubnetGroup
  AWSEBLoadBalancer:
    Type: 'AWS::ElasticLoadBalancing::LoadBalancer'
    DependsOn:
      - AWSEC2SubnetUsEast1a
      - AWSEC2SubnetUsEast1b
      - AWSEC2SubnetUsEast1c
      - AWSEC2SubnetUsEast1d
      - AWSEC2SubnetUsEast1e
      - AWSEC2SubnetUsEast1f
    Properties:
      SecurityGroups:
        - !Ref AWSEC2LoadBalancerSecurityGroup
      Listeners:
        - LoadBalancerPort: '80'
          Protocol: HTTP
          InstancePort: '80'
        - LoadBalancerPort: '443'
          Protocol: HTTPS
          SSLCertificateId: !Ref SSLCertArn
          InstanceProtocol: HTTP
          InstancePort: '80'
      Policies: []
      Subnets:
        - !Ref AWSEC2SubnetUsEast1a
        - !Ref AWSEC2SubnetUsEast1b
        - !Ref AWSEC2SubnetUsEast1c
        - !Ref AWSEC2SubnetUsEast1d
        - !Ref AWSEC2SubnetUsEast1e
        - !Ref AWSEC2SubnetUsEast1f
      HealthCheck:
        Target: !Join
          - ''
          - - 'HTTP:'
            - 80
            - /?study=api
        UnhealthyThreshold: '5'
        Timeout: '5'
        HealthyThreshold: '3'
        Interval: '10'
  AWSEC2LoadBalancerSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: >-
        Elastic Beanstalk created security group used when no ELB security
        groups are specified during ELB creation
      VpcId: !Ref AWSEC2VPC
      SecurityGroupIngress:
        - CidrIp: 0.0.0.0/0
          FromPort: '443'
          ToPort: '443'
          IpProtocol: tcp
        - CidrIp: 0.0.0.0/0
          FromPort: '80'
          ToPort: '80'
          IpProtocol: tcp
      SecurityGroupEgress:
        - CidrIp: 0.0.0.0/0
          FromPort: '80'
          ToPort: '80'
          IpProtocol: tcp